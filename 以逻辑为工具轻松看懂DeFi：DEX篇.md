# 以逻辑为工具轻松看懂DeFi：DEX篇

[![img](https://appserversrc.8btc.cn/avatar/6818/20200831154629_89442.png)区块链资讯](https://www.8btc.com/writer/6818)发布在[区块链](javascript:;)

*本文来源：[机械钟](https://mp.weixin.qq.com/s/1NdEN1iiUaaNTmQCFd3paA)*

*作者：李画*

 

不管一个DeFi 协议、甚至整个DeFi 世界看上去多么陌生和复杂，它本身都是传统金融逻辑（比如交易工具逻辑和借贷工具逻辑），加上适用于区块链或由区块链引发的新逻辑，再加上一点新设计以改进性能，当我们以这个框架来看待和分析DeFi/DeFi 协议时，就会发现它们并不复杂，也没有那么多新东西。

本系列文章将在传统逻辑的基础上，试着梳理出区块链上的新逻辑，然后介绍前两者基础之上的那一点新设计。就让我们从这次DeFi 爆发的导火索，作为交易工具的DEX 开始吧。

![img](https://cdn.8btc.com/static/images/source/2020/08/12/4f0697910508edeb.jpg)

 

## **01交易的传统逻辑**



交易包含两个参与者，买方和卖方，缺一不可；但这两者不一定能找到彼此，就需要有一个公共的交易场所，比如菜市场或者交易所，大家想要交易时都去到这里，买方和卖方也就容易遇到。

对于一个交易场所，最重要的功能是当一个人想买时就能买到（以他可以接受的价格）；当一个人想卖时也能卖出。这与参与该场所的交易数量有关，更多的买单和卖单，也就更容易达成交易。

买单和卖单除了可以由真实的交易者提供外，还可以由做市商来提供，他们本身并没有交易需求，但他们会提供很多的买单和卖单，这样即使缺少真实的买方或卖方，交易者也能通过做市商完成交易。

做市商为什么要这么做？为了赚钱。主要有两个方面的收入，一是他们为交易所提供了最宝贵的流动性，当交易所从真实的买卖双方那儿收取手续费后，会把一部分的手续费给到做市商；二是交易的价格总是在变化，做市商挂出低价格的买单和高价格的卖单，赚取这两者中的差价。

以上是交易工具的基本逻辑，它同时适用于CEX 和DEX。为什么DEX 一直难以发展起来，因为链上的交易者和做市商都不够，或者说流动性不够，就像一个菜市场，虽然干净漂亮，但没人在这儿交易，而越是没人交易，就越难吸引人（包括做市商）过来交易。

 

## **02交易的新逻辑**



那为什么DEX  在今年暴得大名？因为它们找到了一种提供流动性的新方法：AMM（自动化做市商）。在这种方法为DEX 提供了流动性后，DEX 自然就运转了起来。这其中的「旧」逻辑是交易所的运转依赖于流动性，做市商在流动性的提供中扮演着重要角色；叠加的「新」逻辑是AMM，它是且仅是一种新的适合于链上的做市商工作方式。

在AMM 中，做市商是如何工作的？我们以一个流动性不好、需要做市商的菜市场为例来讨论。

一个基于订单簿的菜市场（CEX 和部分DEX）是这样的：一个人来菜市场3块钱一斤卖大米，但没有人想买，做市商就买下这斤大米；第二天有个人来菜市场买大米，看到做市商4块钱一斤的大米，觉得价格合适就买了下来。做市商需要提供两个订单来匹配真实交易者的需求，一个用来买，一个用来卖。

一个AMM 菜市场（Uniswap、Curve 等DEX）是这样的：有一个大台子，台子左边是一堆大米，右边是一堆钱，中间是一个机器人；卖大米的人来了，他只需要把手里的5斤大米放在左边，机器人就会告诉他可以从右边拿走多少钱；买大米的人来了，它只需要把50块钱放在右边，机器人就会告诉他可以从左边拿走多少大米。

做市商的工作变得简单，他只需要把自己的大米和钱以约定的比例放在台子上即可。这里的核心点只是交易价格的计算。系统如何知道每一笔交易的成交价格？其实并不麻烦，通过一个函数算出来。

以Uniswap 为例，它使用的函数是x*y =k，其中k 是约定好的常数，x 是大米的数量，y 是钱的数量，假设规定k =2500，最初的大米数量是50，钱的数量是50；卖大米的人来了，他放下了5斤大米，那么就计算y =2500 /（50+5）=45.45，即当台子上有了55斤大米后，钱的数量应该是45.45，那也意味着卖大米的人可以从台子右边拿走4.55数量的钱（50 - 45.45=4.55）。

如果卖大米的人接着卖5斤大米会发生什么？计算y =2500/（55+5）=41.67,那么卖大米的人可以从台子右边拿走3.78数量的钱（45.45-41.67=3.78）。

为什么同样是卖5斤大米，第一次可以卖出4.55的钱，第二次只能卖出3.78？这就是用函数来定价的一个缺点：滑点。x 被卖入的越多，x 越便宜；x 被买走的越多，x 越贵。

滑点的存在为DEX 引入了一个新角色，套利者。卖大米的人第二次是以3.78的价格卖出了5斤大米，遵循x *y  =k，如果这时候买入5斤大米，也只需要花费3.78。这个便宜的价格不一定是因为大米真的便宜了，而是在这个交易池里被一个方向上的卖单变得便宜。

可以认为套利者也是做市商，他们让交易池重新平衡，让交易价格趋近合理；试想如果这个市场全是卖大米的，又没有套利者，那这个交易池是难以继续下去的，因为大米价格太低。

不难发现，在订单簿模式下，做市商赚交易费和价格差这两个部分的钱；在AMM 中，做市商，或者说流动性提供者只赚交易费这一个部分的钱，而套利者则赚价格差这一部分的钱。这是订单簿和AMM 因为不同的原理导致的一个比较大的不同。

需要注意的是，滑点与交易池的大小有关，比如台子上有500的大米和500的钱，那么卖两次5斤大米能拿走的钱分别是4.95和4.84，滑点相对较小。这是AMM 类DEX 把流动性提供看得无比重要的原因，一个交易池越大，它的滑点就越低，用户体验也就越好。

 

## **03不同协议的一点新设计**



滑点还与DEX选择的定价函数有关，比如我们用x+y =k来定价，同样买卖大米，k=100，最初的大米数量是50，钱的数量是50。卖大米的人来了，他放下了5斤大米，就可以拿走5份钱，因为这就令到k =100；他又放下5斤大米，又可以拿走5块钱，因为这令k =100。

在该函数下，完全没有滑点；但有一个致命的缺点，假如在这个市场外1份钱买不到1斤大米（而这个市场永远是一份钱对应一份大米），就会有另一种套利者来该市场买走所有的大米，让交易池里只剩下100份钱。

这对于流动性提供者来说是一种较大的风险，因为他本来有50的大米和50的钱，如果大米涨到2份钱一斤，他就有150份的钱；而现在留给他的只是100份的钱。所以x+y =k虽然能避开滑点，但风险太高无法被单独使用，它只能与其他函数一起使用以减少滑点，且更适合x 和y 的相对价格波动较小的情况。

而这就是为什么会有Curve。它服务的是稳定币间的交易，便可以针对这种特定的交易场景（x 和y 价格波动小）设计定价函数，它在x*y =k的基础上加入了x+y =k，实现交易体验的优化。这种不同定价函数的选择，就是前文中提到的不同协议间的那「一点新设计」。

x+y =k 带来的这种风险被称为无常损失，所有AMM 都会有无常损失问题，因为只要交易池内的价格与外部世界的价格不一致，就会有套利者来「搬平价格」，而套利者赚到的，就是流动性提供者损失的。

因此又出现了一批新的DEX，比如Bancor V2，它们通过使用预言机引入外部世界的价格，从而降低交易池与外部世界价格不一致的风险，减少无常损失。而在函数定价的基础上加入预言机定价，就是那「一点新设计」。

所以，当看到层出不穷的新协议/新应用时，不要被废话和细节淹没，直接去看它的新的定价方法即可。而看一个定价方法，就是看它是如何通过设计（通过函数的选择、通过与预言机的结合等）来减少滑点和减少无常损失的。

有趣的是，滑点和无常损失间存在一些互斥关系，减少滑点追逐的是一种价格的稳定，减少无常损失追逐的是一种价格的变化，优化一边可能会损失另一边；最新的潮流是引入预言机来打破滑点和无常损失之间的关系，做到只减少无常损失，但预言机又会带来预言机自身的问题。

因此当你在看这一个点上的新设计时，要注意它的正反两面，以及由此决定的它的适用场景。

我们并不需要掌握一个定价函数/定价方法的全部细节，只需要知道上述这些它的基本工作原理，以及它的实际应用效果即可。实际应用效果可以通过曲线图简单、快速、全面地知晓。

比如当你想要了解Uniswap 的无常损失情况时，就只需要看下图，其中的蓝色曲线展示了当价格发生什么样的变化时，无常损失会有多少。

![img](https://cdn.8btc.com/static/images/source/2020/08/12/75d4895eeeb54c96.jpg)

以三个点为例子：黄线与蓝线的交叉点是当外部价格没有发生变化时，无常损失为零；绿线与蓝线的交叉点分别是当价格跌了50%后，以及价格涨了100%后，无常损失都为-5.7%，不难发现损失与价格变化的幅度有关，与方向无关。

总而言之，当需要了解不同的或新的交易类协议时，奔着它的定价方法原理和曲线图去即可，鉴于协议的提出者一定会强调和解释自己定价方法的特点，我们要做的工作其实就是在听完他们的话后，看曲线图在滑点和无常损失上的表现是怎么样的。

 

## **04DEX的简要总结**



真正的DeFi 可能是一门学科的体量，但目前的DeFi 并不算复杂，不要被泡沫、被太多的词语、被他人赋予它的外衣迷惑，以及最重要的：了解DeFi 最好的途径是使用它。

最后是一个简要的总结：

1. AMM 是懒人版的做市商，低门槛版的做市商。做市商不需要专业知识，也不需要工作，他们只需要把钱放入交易池即可。这为把闲置资金投入到做市中来打开了方便之门。
2. AMM 类DEX 的设计，其核心是定价方法的设计，虽然有诸多不同的设计，但它们的主要目的都是为了减少滑点以及减少无常损失。
3. 如果你有一笔资金，你可以：成为做市商赚钱；通过策略在交易池内部套利赚钱；通过策略在不同交易池间套利赚钱。
4. 虽然风头正劲的是AMM，但也不要忘了订单簿模式的DEX，它们有突出的优势，只不过目前还缺流动性。订单簿模式似乎在可组合性上会逊于AMM，但我并不确定，而两者是否会有这个区别会比较重要。

# 如何解决MEV的痛点？从MEV-Explore、keeperDAO、ArcherDAO等说起

[![img](https://appserversrc.8btc.cn/viking/552640dded65d9c0c90ef915fc6536d5.jpeg)蜂巢Tech](https://www.8btc.com/writer/582659)发布在[海盗号 ](javascript:;)[DeFi](javascript:;)

![img](https://appserversrc.8btc.cn/FqBFVijEN8ARoh9Ylzqlq12b3iDu.png)

原标题：《MEV应用：为公平提取以太坊网络价值而来》

随着DeFi协议应用的发展，越来越复杂的智能合约部署在以太坊网络中，合约与合约之间的交互过程不但复杂且频次高，每一次合约交互都隐藏着财富机会，比如套利，比如清算，链上应用的繁荣也使链上交易可捕获的价值增加，这些价值被统称为Maximum Extractable Value，简称即MEV。

根据MEV数据网站Flashbots 统计，自2020年1月到今年6月，以太坊网络的MEV达7.49亿美元，近30天被提取的价值高达2.39亿美元，已经成为一块不容忽视的市场。

但矿工可提取价值在网络交易过程中，存在抢跑和尾随交易，往往会导致以太坊GAS过高，带来链上拥堵、高交易滑点等问题，影响链上其他用户的使用体验。

于是，越来越多的专业开发者致力于解决矿工提取价值过程中的不透明、无秩序的现状，以保护普通用户的交易利益，这种解决方案甚至以应用的方式出现，MEV-Explore、keeperDAO、CowSwap便是这类应用。

本期DeFi蜂窝将带来MEV及其相关应用的梳理。



## **什么是MEV？**



MEV是MinerExtractable Value简称，原本是指矿工可提取价值。

作为以太坊区块数据的打包者，矿工有很多主动权。在打包区块过程中，他们可以将交易包含进来或排除在外，要对交易进行排序，这个操作也让矿工提取除了正常的交易费用和区块奖励之外的价值，这个价值就是MEV。

而当前在以太坊生态上，MEV并不仅仅有矿工在提取，还有专注于DeFi的交易员，也有机器人运营商，他们通过套利策略获得MEV，留给矿工的只剩下交易员在挖掘MEV过程中支付的交易费，因此，矿工能获得链上MEV仅仅是小部分。

DeFi交易员、套利机器人加入到链上提取价值的行列，因此，MEV定义不再仅仅是矿工可提取价值（Miner Extractable Value），它发生了词变，变为最大可提取价值（Maximum Extractable Value）。

在理解MEV之前，需了解以太坊链上的运转流程。这个区块链网络上主要有3个角色，我们用一个形象的比喻做说明——矿工是生产者，矿池像是拍卖行，用户相当于投标人。

每当用户启动交易后，交易信息会广播到节点，每笔交易均附有手续费，也就是GAS费。费用代表用户购买区块空间的意愿，使其能够让他的这笔交易包含在区块内。矿池会把这些交易信息分配给矿工，而矿工为追求收益，会优先打包GAS费高的交易。

此时，交易用户为了让自己的交易被优先处理，就会出高价GAS费，这种行为就是「最优GAS费竞拍」(Priority Gas Auction)，简称为PGA。

在DeFi应用繁荣以前，以太坊就是这样按区块顺序有序运行的，链上MEV价值集中在矿工身上。随着DeFi协议的爆炸式增长，超额抵押借贷、AMM、收益挖矿策略、衍生品等智能合约的组合与交互越来越复杂。以太坊网络不再仅仅只支撑链上转账交易，可以捕获的价值将越来越多，智能合约的每次交互，都暗藏着巨大的财富，MEV也就变得丰富起来。

MEV在DeFi领域，主要产生于套利交易和清算这两个主要场景。

**套利交易**——以Uniswap为例，当有一笔大额交易在该DEX上产生滑点时，假如有价值10000美元的套利机会，DeFi交易员或机器人套利者就会扑捉到这个信息，执行套利交易。他们会提交这笔交易给矿工。为了让提交的交易被矿工优先打包处理，他们通常会给出高价GAS，哪怕是价值3000美元。此时，剩余的7000美元就是DeFi交易员或机器人套利者可提取的MEV。而那3000美元GAS费，则是矿工在此笔交易获得的MEV。

套利机会不仅仅存在于大额交易的场景中，也会产生在不同DEX之间，比如，当ETH/SHIB在Uniswap和Bancor上出现不同的价格时，套利者就会在两个DEX间搬砖，使价格最终趋于一致。

**清算交易**——在DeFi抵押借贷协议中，当抵押品价值下降时，如果没有补足或者出售抵押资产，就会触发清算程序，清算人可以以低于市场价格3%-5%的折扣，获得如ETH这样的抵押资产，而这3%-5%的折扣价值，也是MEV。



## **MEV市场存在诸多痛点** 

- **抢跑行为带来利益分配不公平**

当前的以太坊网络上，捕获MEV的主要包括DeFi交易员、套利机器人运营商，也有普通用户，他们都是MEV的搜寻者，在链上各种合约交互的场景中，寻找收益机会。

假如一个DeFi交易员在Uniswap上发现了套利机会，把交易提交给矿工，但由于链上数据都是公开的，所有人都能监控到这个交易员提交的套利交易信息，当MEV价值十分可观时，包括矿工在内的搜寻者，就有可能以更高的GAS费「抢跑」——复制这条交易信息，出更高价格的Gas费「搭个便车」。

于是，一个以GAS费竞价争取此次套利机会的场面出现了，这对第一个发现套利机会的交易员显得很不公平，如果他出不起更高的GAS费，那么他发现这个「宝藏」便只能拱手让给「有钱人」。

- **GAS费过高浪费区块空间**

OK，如果你认为崇尚交易自由的DeFi，就应该遵循优胜劣汰的市（丛）场（林）法则——MEV一旦被搜寻者发现，就要尽快以高价GAS费提交此笔收益，争夺机会。

想想矿工会怎么做？最大的可能是打包出钱（GAS费）最多的那笔交易。这就会造成因优先打包而带来的区块空间被减少的问题，此时，网络有可能变得拥堵起来，链上交易的GAS费也被抬高了。

- **三明治夹击**

除了上述问题外，大额的DEX交易场景中还会存在「三明治夹击」这种颇受争议的获利方式。一些脚本能力更强的「科学家」交易员，通过使目标交易夹在两笔特定交易中间从而获利。

同样以Uniswap的AMM式兑换场景举例，假如ETH价值1000美元，用户A用1000 USDT买入ETH，科学家盯上了A。他先于A构造了一笔1100 USDT买入ETH的交易；排在后面的A想要成交，就要用更多的USDT买入ETH，比如1150USDT。此时，科学家卖出ETH,从而赚了一笔差价，而真实的交易用户还要承受更大的滑点损失。

- **矿工双重角色挑战**

在以太坊生态中，矿工的主要收入由四部分组成：区块奖励，叔块奖励，交易费用，MEV收益。你发现了吗？作为处理交易顺序的矿工，既有机会当裁判员，也有机会当运动员。

当链上其他用户提交的MEV收益高于区块奖励和交易费用时，矿工就会进入两难抉择之中——到底是选择抢夺此笔交易，还是选择重挖区块来捕获区块中的MEV。这对矿工来说是个诱惑，为了使下一个块建立在自己套利成功的区块上，他会努力使包含自己套利交易的块成为最长链。



## **解决MEV痛点的应用出现**



当链上交易秩序甚至网络效率因MEV的丰富而带来不利时，一些开发者试图通过一些方案解决痛点。

- **MEV-Explore浏览器**

MEV-Explore是一款以太坊MEV 交易实时资讯面板和浏览器，用来展示MEV 价值、分类、最新MEV交易、MEVGas 费消耗等相关资讯，网站数据每 3 小时更新一次。这款应用旨在帮助社区了解和量化MEV，从而观察它对以太坊网络的影响。

MEV-Explore的开发方是Flashbots——一家专门研究矿工可提取价值（MEV）的机构。既然MEV 客观存在，无法避免，Flashbots希望能为搜寻者和矿工建立MEV利益分配秩序，降低MEV对公链的影响和风险。

Flashbots缓解 MEV影响的解决方案分为三部分：点亮黑暗森林，价值挖掘民主化，分配利润。

由于MEV目前对以太坊用户不透明，普通交易用户即使曾遭受过抢跑或三明治夹击也感受不到MEV的存在，理解它需要大量的数据分析和智能合约的深入了解。Flashbots希望MEV-Explore能够让MEV活动透明化，减少信息不对称，同时希望能将MEV量化，有衡量指标并且这些指标可视化。

对于在提取MEV过程中的高GAS费，Flashbots提出的解决方案是MEV-Geth，简单来说就是把MEV交易隔离起来，用专属渠道进行矿工和搜寻者交易竞拍，通俗理解就是把这些交易移到链下，以缓解链上GAS费过高和拥堵。

- **Alchemist解决方案**

Alchemist(MIST)基于Flashbots技术推出了首个去中心化交易所mistX,号称第一个FlashDEX，主要是解决抢跑问题，用来保护普通用户在交易过程免受抢跑攻击和三明治夹击。若抗抢跑失败，不需要支付任何费用。

这就意味着在mistX上，你的交易，要么在没有抢跑交易的情况下交易成功，要么无需支付任何费用。不像传统的链上交易，不但面临着被抢先交易，还要损失提交的GAS费。

mistX交易宣称交易无需GAS费，所有交易的GAS价格都是0。但这并不意味着没有手续费，只是支付方式与传统的交易方式不同——mistX用户在交易过程中是向矿工支付小费，这些小费以ETH支付。如果交易中包含ETH，就会把消费包含在交易中；交易中没有ETH，那么需要从你钱包的ETH中扣除。

简单来说，交易无需GAS费，但需从每笔交易中扣除一定比例的小费。最重要的一点是在mistX取消提交的交易时，没有任何费用。

mistX独特之处是利用了Flashbots机构提出的解决方案，将用户交易捆绑在一起。也就是说，通过mistX交易信息不会发布到公开池，这样有效地向抢跑者隐藏了信息，从而防止交易被操纵，或被抢跑，或被夹在中间。

- **KeeperDAO解决方案**

KeeperDAO（ROOK）旨在让DeFi用户和交易搜寻者（Keeper）利益最大化，这种方式也强调并非保护矿工利益。

KeeperDAO专门为套利者创建了一个资金池：任何人都能向这个资金池借钱套利，并获得套利收益的一部分。

它相当于链上流动性承销商，流动性提供者将资金存入资金池中，套利者或清算人（Keeper）会利用流动池中的资金捕捉链上套利机会。当有套利机会发生时，套利者会以闪电贷的形式借用流动池中的资金，并在套利成功后将本金还回流动池中，套利者所得收益会被存入社区池中然后等待分配奖励，提供流动性的用户也将获得原生代币ROOK作为奖励。

在其整个套利或清算过程中，Keeper主要面临的挑战就是提交套利交易过程的PGA竞拍，比如，当你捕捉到套利机会时，为了让此笔交易优先被矿工打包，就面临着是否要提供高价GAS费竞拍交易顺序。如果提供高昂的GAS费，而这无休止的GAS费混乱争夺中，套利者利润相比原始利润少之又少。

获益的总是掌握交易控制权的矿工，他们可以获得MEV最大价值。如果不提供高价GAS费，交易会不会被竞争者抢跑？为避免此种情况，KeeperDAO通过专门的智能合约将此笔交易封装，消除MEV。

也就是说，出现一笔套利交易机会时，搜寻者（Keeper）提交给KeeperDAO，让它分析是否有套利机会（通过抢先交易或尾随交易）。如果有套利机会，KeeperDAO获得套利和清算优先权，同时能降低以太坊矿工为获取MEV价值控制交易排序的风险。交易完成后，KeeperDAO用ROOK对搜寻者加以奖励。

尽管搜寻者（Keeper）获得利润减少，但损失少于 PGA 竞争的GAS损失。对KeeperDAO 和搜寻者来说，这是双赢。

目前用户可以通过提供ETH、WETH、USDC、renBTC、DAI等资金池的流动性来获得收益。ROOK初始供应量共100万个，截至6月9日，其市值2.1亿美元，暂报价为179$，持币地址数有18777个。

- **ArcherDAO解决方案**

ArchrDAO（ARCH）旨在增加矿工的收入，希望通过联合策略提供者提供高价值的链上交易机会（如套利/清算），然后在以太坊上重新排序交易来提高矿工收入，并优化交易者体验。

ArcherDAO生态主要有3个角色，分别是策略提供者、矿工、流动性提供者。后两者较好理解，而策略提供者是发现并提交链上收益机会的一方，这些机会包括DEX中的套利、贷款清算及其它机会。

ArcherDAO系统评估这些收益机会后，会将高价值的机会发送给矿工，由矿工打包进入区块并产生收益。

整体来看，ArcherDAO 是一个让套利者和矿工直接合作的平台，通过联合策略提供者和矿工，用执行有利可图的链上机会，为矿工带来新收入来源。不同于PGA解决方案，ArcherDAO让套利者和矿工双方合作，从而使MEV利益最大化，避免了为实现套利而浪费GAS费用。

- **CowSwap方案**

CowSwap用批量拍卖来抵御MEV攻击，并集成各去中心化交易所作为流动性来源，为交易者提供最优价格。

CowSwap是采用一种独特的需求匹配CoW(Coincidence of Wants)的方式进行撮合交易。当交易双方两人同时拥有彼此需求的资产时，双方便可以不通过货币媒介，直接进行交易，可以理解为链上的「物物交易」。

也就是说，当一批交易发生时，CowSwap首先在链下为交易者匹配订单，如果它没有找到可匹配的需求交易，则将交易提交到链上其他 DEX。

在 CowSwap 上，两个人同时持有彼此想要的资产，即可直接匹配交易，而无需做市商或流动性提供者撮合交易。这样既然可以为个人交易者带来最佳的价格，也免除通过做市商或流动性提供者产生的手续费。

CowSwap需要链上的外部流动性，因此采用批量订单的方式，按统一价格结算。所有订单价格一致，没有交易排序的问题，所以不能通过将交易按特定顺序排序来提取任何价值，从根本上免除MEV情况。

本文链接：https://www.8btc.com/article/6648123